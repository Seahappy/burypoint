<!--
 * @Descripttion: 
 * @Author: Cxy
 * @Date: 2022-02-11 17:34:11
 * @LastEditors: Cxy
 * @LastEditTime: 2023-05-17 08:52:47
 * @FilePath: \futian\pnpmft\html\history.html
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div class="box flex-box">
    <span onclick="hash('/1')" class="flex1 center route">home</span>
    <span onclick="hrerNew()" class="flex1 center route">shop</span>
    <span onclick="historyR('/3')" class="flex1 center route">shopcar</span>
    <span onclick="hrer()" class="flex1 center route">usercenter</span>
  </div>
  <button onclick="hisGo()">hisGo</button>
  <button onclick="hisBack()">hisBack</button>
  <button onclick="hisForward()">hisForward</button>
  <button onclick="javascript:void(history.pushState('','','/a'))">123</button>
</body>
<script>
  const hash = (path) => {
    location.hash = path
  }
  const hrerNew = () => {
    location.href = 'http://127.0.0.1:5500/pnpmft/html/history.html'
  }
  const historyR = (path) => {
    // history.pushState({}, '', 'http://127.0.0.1:5500/pnpmft/html/hash.html#/3')
    history.replaceState({}, '', 'http://127.0.0.1:5500/pnpmft/html/history.html#/3')
  }
  const hrer = () => {
    location.href = 'http://127.0.0.1:5500/pnpmft/html/history.html#/4'
  }

  const hisGo = () => {
    history.go(1)
  }
  const hisBack = () => {
    history.back()
  }
  const hisForward = () => {
    history.forward()
  }
  class HistoryRouter {
    handlers = {};
    constructor() {
      this.refresh = this.refresh.bind(this);
      this.addStateListener();
      window.addEventListener('load', this.refresh, false);
      window.addEventListener('popstate', this.refresh, false);
      window.addEventListener('pushState', this.refresh, false);
      window.addEventListener('replaceState', this.refresh, false);
    }
    addStateListener() {
      const listener = function (type) {
        var orig = history[type];
        return function () {
          var rv = orig.apply(this, arguments);
          var e = new Event(type);
          e.arguments = arguments;
          window.dispatchEvent(e);
          return rv;
        };
      };
      window.history.pushState = listener('pushState');
      window.history.replaceState = listener('replaceState');
    }
    refresh(event) {
      this.emit('change', location.pathname);
    }
    on(evName, listener) {
      this.handlers[evName] = listener;
    }
    emit(evName, ...args) {
      const handler = this.handlers[evName];
      if (handler) {
        handler(...args);
      }
    }
  }
  console.log(window.history);
  const router = new HistoryRouter();
  router.on('change', function (curUrl) {
    console.log(curUrl);
  });
</script>

</html>